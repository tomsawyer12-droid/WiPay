<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIPAY - Super Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* Custom Overrides for Super Admin */
        .sidebar {
            background: #1a1a2e;
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #673ab7, #512da8);
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="search-box">
                <div style="color:white; font-weight:bold; padding: 10px;">SUPER ADMIN</div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">MANAGEMENT</div>
                <ul>
                    <li><a href="#" onclick="switchView('tenants'); return false;">Tenants</a></li>
                    <li><a href="#" onclick="switchView('stats'); return false;">System Stats</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- New Main Header -->
            <header class="main-header">
                <div class="header-left">
                    <img src="img/favicon.png" alt="WiPay Logo" class="header-logo">
                    <span class="brand-name">WiPay Super</span>
                </div>

                <div class="header-right">
                    <span id="welcomeMsg" style="text-transform: uppercase;">WELCOME, SUPER ADMIN</span>
                    <a href="#" id="logoutLink">LOG OUT</a>
                </div>
            </header>

            <!-- Tenants View -->
            <div id="tenantsView" class="view-section">
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Tenants (Admins)</h2>
                    <button class="btn-save" onclick="openModal('addTenantModal')">+ Add Tenant</button>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Billing</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tenantsTableBody">
                            <!-- JS renders rows here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Stats View (Hidden by default) -->
            <div id="statsView" class="view-section hidden">
                <div class="content-header">
                    <h2>System Statistics</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card purple">
                        <div class="stat-value" id="total-tenants">0</div>
                        <div class="stat-label">Total Tenants</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-value" id="total-vouchers">0</div>
                        <div class="stat-label">Total Vouchers</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-value" id="total-revenue">0</div>
                        <div class="stat-label">Total Revenue (UGX)</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-value" id="total-commission">0</div>
                        <div class="stat-label">Total Commission (5%)</div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Add Tenant Modal -->
    <div id="addTenantModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content">
            <h3>Add New Tenant</h3>
            <input type="text" id="newTenantUser" placeholder="Username"
                style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <input type="password" id="newTenantPass" placeholder="Password"
                style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <div style="margin-bottom: 15px;">
                <label style="color: white; font-size: 0.9em; display: block; margin-bottom: 5px;">Billing Type:</label>
                <select id="newTenantBilling" style="width: 100%; padding: 10px;">
                    <option value="commission">Commission (5% per sale)</option>
                    <option value="subscription">Subscription (Fixed Monthly)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button onclick="createTenant()" class="btn-save">Create</button>
                <button onclick="closeModal('addTenantModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Renew Subscription Modal -->
    <div id="renewModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content">
            <h3>Renew Subscription</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">Set the new expiry date for this tenant.</p>
            <input type="date" id="renewDate" style="width: 100%; padding: 10px; margin-bottom: 20px;">
            <div class="modal-actions">
                <button onclick="submitRenew()" class="btn-save">Save</button>
                <button onclick="closeModal('renewModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- Auth Helper ---
        async function fetchAuth(url, options = {}) {
            const token = localStorage.getItem('wipay_token');
            if (!token) return window.location.href = 'login.html';

            const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', ...options.headers };
            const res = await fetch(url, { ...options, headers });

            if (res.status === 401 || res.status === 403) {
                localStorage.removeItem('wipay_token');
                window.location.href = 'login.html';
                return Promise.reject('Unauthorized');
            }
            return res;
        }

        // --- Logout ---
        document.getElementById('logoutLink').onclick = (e) => {
            e.preventDefault();
            localStorage.removeItem('wipay_token');
            window.location.href = 'login.html';
        };

        // --- Views ---
        function switchView(view) {
            document.getElementById('tenantsView').classList.add('hidden');
            document.getElementById('statsView').classList.add('hidden');
            document.getElementById(view + 'View').classList.remove('hidden');

            if (view === 'tenants') fetchTenants();
            if (view === 'stats') fetchStats();
        }

        // --- Tenant Logic ---
        async function fetchTenants() {
            try {
                const res = await fetchAuth('/api/super/tenants');
                const tenants = await res.json();
                const tbody = document.getElementById('tenantsTableBody');
                tbody.innerHTML = '';

                tenants.forEach(t => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${t.id}</td>
                            <td>${t.username}</td>
                            <td>${t.role}</td>
                            <td>
                                <div>${t.billing_type || 'commission'}</div>
                                ${t.billing_type === 'subscription'
                            ? `<small style="color:${getExpiryColor(t.subscription_expiry)}">${formatExpiry(t.subscription_expiry)}</small>`
                            : ''}
                            </td>
                            <td>${new Date(t.created_at).toLocaleDateString()}</td>
                            <td>
                                ${t.role !== 'super_admin' ? `<button class="btn-cancel" onclick="deleteTenant(${t.id})">Delete</button>` : '-'}
                                ${t.billing_type === 'subscription' ? `<button class="btn-save" style="margin-left:5px; font-size:0.7rem;" onclick="openRenewModal(${t.id}, '${t.subscription_expiry || ''}')">Renew</button>` : ''}
                            </td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function createTenant() {
            const username = document.getElementById('newTenantUser').value;
            const password = document.getElementById('newTenantPass').value;
            const billing = document.getElementById('newTenantBilling').value;

            if (!username || !password) return alert('Fill all fields');

            try {
                const res = await fetchAuth('/api/super/tenants', {
                    method: 'POST',
                    body: JSON.stringify({ username, password, billing_type: billing })
                });

                if (res.ok) {
                    alert('Tenant Created');
                    closeModal('addTenantModal');
                    fetchTenants();
                } else {
                    const data = await res.json();
                    alert(data.error || 'Failed');
                }
            } catch (e) { console.error(e); }
        }

        async function deleteTenant(id) {
            if (!confirm('Are you sure you want to delete this tenant?')) return;

            try {
                const res = await fetchAuth(`/api/super/tenants/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    fetchTenants();
                } else {
                    alert('Failed to delete');
                }
            } catch (e) { console.error(e); }
        }

        async function fetchStats() {
            try {
                const res = await fetchAuth('/api/super/stats');
                const data = await res.json();
                document.getElementById('total-tenants').textContent = data.tenantCount;
                document.getElementById('total-vouchers').textContent = data.totalVouchers;
                document.getElementById('total-revenue').textContent = Number(data.totalRevenue).toLocaleString();
                document.getElementById('total-commission').textContent = Number(data.totalCommission).toLocaleString();
            } catch (e) { console.error(e); }
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // Start
        fetchTenants();

        function getExpiryColor(dateStr) {
            if (!dateStr) return '#aaa';
            const diff = new Date(dateStr) - new Date();
            if (diff < 0) return '#f44336'; // Expired
            if (diff < 1000 * 60 * 60 * 24 * 3) return '#ff9800'; // Warning
            return '#4caf50';
        }

        function formatExpiry(dateStr) {
            if (!dateStr) return 'Not Set';
            return new Date(dateStr).toLocaleDateString();
        }

        let currentRenewId = null;
        function openRenewModal(id, currentExpiry) {
            currentRenewId = id;
            document.getElementById('renewDate').value = currentExpiry ? currentExpiry.split('T')[0] : '';
            openModal('renewModal');
        }

        async function submitRenew() {
            const date = document.getElementById('renewDate').value;
            if (!date) return alert('Select a date');

            try {
                const res = await fetchAuth(`/api/super/tenants/${currentRenewId}/subscription`, {
                    method: 'PATCH',
                    body: JSON.stringify({ expiry_date: date })
                });
                if (res.ok) {
                    alert('Subscription Updated');
                    closeModal('renewModal');
                    fetchTenants();
                } else {
                    alert('Failed to update');
                }
            } catch (e) { console.error(e); }
        }

    </script>
</body>

</html>