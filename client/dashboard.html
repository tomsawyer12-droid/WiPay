<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WIPAY - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/dashboard.css">
    <script>
        if (!localStorage.getItem('wipay_token')) {
            window.location.href = 'login.html';
        }
    </script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="search-box">
                <input type="text" placeholder="Start typing to filter...">
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">DATA</div>
                <ul>
                    <li data-view="dashboard"><a href="#" onclick="switchView('dashboard'); return false;">Dashboard</a>
                    </li>
                    <li data-view="categories"><a href="#" onclick="switchView('categories'); return false;">Categories
                            <span class="add-btn">+
                                Add</span></a></li>
                    <li data-view="packages"><a href="#" onclick="switchView('packages'); return false;">Packages <span
                                class="add-btn">+
                                Add</span></a></li>
                    <li data-view="vouchers"><a href="#" onclick="switchView('vouchers'); return false;">Vouchers</a>
                    </li>
                </ul>

                <div class="nav-section">FINANCE</div>
                <ul>
                    <li data-view="payments"><a href="#" onclick="switchView('payments'); return false;">Payments</a>
                    </li>
                </ul>

                <div class="nav-section">COMMS</div>
                <ul>
                    <li><a href="#" onclick="showAlert('Ads feature coming soon'); return false;">Ads <span
                                class="add-btn">+ Add</span></a></li>
                    <li data-view="sms"><a href="#" onclick="switchView('sms'); return false;">SMS</a></li>
                </ul>

                <div class="nav-section">SYSTEM</div>
                <ul>
                    <li><a href="#" onclick="showAlert('Locations feature coming soon'); return false;">Locations</a>
                    </li>
                    <li><a href="#" onclick="openDashModal('subscriptionModal'); return false;">Subscription</a></li>
                    <li><a href="#" onclick="showAlert('Web Configs feature coming soon'); return false;">Web
                            Configs</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Expiry Banner (Responsive) -->
            <div id="expiryBanner" style="
                display: none; 
                width: 100%; 
                background: #e74c3c; 
                color: white; 
                text-align: center; 
                padding: 15px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                cursor: pointer;
                box-sizing: border-box;
                word-wrap: break-word;
                margin-bottom: 20px;" onclick="openDashModal('subscriptionModal')">
                <strong>⚠️ ALERT:</strong> Your Subscription to WiPay has expired.
                <span style="text-decoration: underline; margin-left: 10px; white-space: nowrap;">Click here to
                    Renew</span>
            </div>

            <!-- New Main Header -->
            <header class="main-header">
                <div class="header-left" onclick="switchView('dashboard')" style="cursor: pointer;"
                    title="Go to Dashboard">
                    <!-- Mobile Hamburger -->
                    <div class="mobile-menu-btn hidden-desktop" onclick="toggleSidebar(); event.stopPropagation();">
                        ☰
                    </div>
                    <!-- Desktop Hamburger -->
                    <div class="desktop-menu-btn hidden-mobile"
                        onclick="toggleDesktopSidebar(); event.stopPropagation();"
                        style="font-size: 1.5rem; margin-right: 15px; cursor: pointer; color: white;">
                        ☰
                    </div>
                    <img src="img/favicon.png" alt="WiPay Logo" class="header-logo">
                    <span class="brand-name">WiPay</span>
                </div>

                <div class="header-center">
                    <button class="btn-sell-voucher"
                        onclick="loadPackagesForSell(); openDashModal('sellVoucherModal')">Sell Voucher</button>
                </div>



                <div class="header-right">
                    <span id="welcomeMsg" style="text-transform: uppercase;">WELCOME, ADMIN</span>
                    <a href="/" target="_blank">VIEW SITE</a> /
                    <a href="#" onclick="openDashModal('changePassModal')">CHANGE PASSWORD</a> /
                    <a href="#" id="logoutLink">LOG OUT</a>
                    <span class="theme-toggle">◐</span>
                </div>
            </header>

            <!-- Sub Header (Breadcrumbs) -->
            <div class="sub-header">
                <div class="breadcrumb" id="breadcrumb">Home > Dashboard</div>
            </div>

            <!-- Mobile Navigation (Visible only on mobile) -->
            <div class="mobile-nav hidden-desktop">
                <div class="mobile-nav-btn" data-view="dashboard" onclick="switchView('dashboard')">Dashboard</div>
                <div class="mobile-nav-btn" data-view="categories" onclick="switchView('categories')">Categories</div>
                <div class="mobile-nav-btn" data-view="packages" onclick="switchView('packages')">Packages</div>
                <div class="mobile-nav-btn" data-view="vouchers" onclick="switchView('vouchers')">Vouchers</div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboardView" class="view-section">
                <div class="content-header">
                    <h2>Dashboard</h2>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <!-- Row 1 -->
                    <div class="stat-card cyan">
                        <div class="stat-value" id="sms-balance">Loading...</div>
                        <div class="stat-label">SMS Balance</div>
                        <div class="card-footer" onclick="openDashModal('buySMSModal')" style="cursor: pointer;">Buy SMS
                            <span class="arrow">→</span>
                        </div>
                    </div>

                    <div class="stat-card green">
                        <div class="stat-value" id="balance">Loading...</div>
                        <div class="stat-label">Mobile Money Balance</div>
                        <div class="card-footer" onclick="openDashModal('withdrawModal')" style="cursor: pointer;">
                            Withdraw UGX <span class="arrow">→</span></div>
                    </div>

                    <div class="stat-card gray">
                        <div class="stat-value" id="daily-trans">0</div>
                        <div class="stat-label">Daily Transacted</div>

                    </div>

                    <div class="stat-card red">
                        <div class="stat-value" id="weekly-trans">0</div>
                        <div class="stat-label">Weekly Transacted</div>

                    </div>

                    <!-- Row 2 -->
                    <div class="stat-card blue">
                        <div class="stat-value" id="monthly-trans">0</div>
                        <div class="stat-label">Monthly Transacted</div>

                    </div>

                    <div class="stat-card yellow">
                        <div class="stat-value" id="yearly-trans">0</div>
                        <div class="stat-label">Yearly Transacted</div>

                    </div>

                    <div class="stat-card gray">
                        <div class="stat-value" id="total-trans">0</div>
                        <div class="stat-label">Total Transacted</div>

                    </div>

                    <div class="stat-card blue">
                        <div class="stat-value" id="bought-vouchers">0</div>
                        <div class="stat-label">Bought Vouchers</div>
                        <div class="card-footer">More info <span class="arrow">→</span></div>

                    </div>

                    <!-- Row 3 -->
                    <div class="stat-card green">
                        <div class="stat-value" id="cat-count">0</div>
                        <div class="stat-label">Categories</div>
                        <div class="card-footer" onclick="switchView('categories')" style="cursor: pointer;">More info
                            <span class="arrow">→</span>
                        </div>
                    </div>

                    <div class="stat-card gray">
                        <div class="stat-value" id="pkg-count">0</div>
                        <div class="stat-label">Packages</div>
                        <div class="card-footer" onclick="switchView('packages')" style="cursor: pointer;">More info
                            <span class="arrow">→</span>
                        </div>
                    </div>

                    <div class="stat-card red">
                        <div class="stat-value" id="voucher-count">0</div>
                        <div class="stat-label">Vouchers</div>
                        <div class="card-footer" onclick="switchView('vouchers')" style="cursor: pointer;">More info
                            <span class="arrow">→</span>
                        </div>
                    </div>

                    <div class="stat-card yellow">
                        <div class="stat-value" id="payments-count">0</div>
                        <div class="stat-label">Payments</div>
                        <div class="card-footer">More info <span class="arrow">→</span></div>
                    </div>
                </div>
            </div>

            <!-- Categories View (Hidden by default) -->
            <div id="categoriesView" class="view-section hidden">
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Categories</h2>
                    <button class="btn-success" onclick="openDashModal('addCategoryModal')">+ Add Category</button>
                </div>
                <div class="table-responsive table-scroll-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                            <!-- JS renders rows here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Packages View (Hidden by default) -->
            <div id="packagesView" class="view-section hidden">
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Packages</h2>
                    <button class="btn-success" onclick="openDashModal('addPackageModal')">+ Add Package</button>
                </div>
                <div class="table-responsive table-scroll-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Price (UGX)</th>
                                <th>Duration (Hrs)</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody id="packagesTableBody">
                            <!-- JS renders rows here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vouchers View (Hidden by default) -->
            <div id="vouchersView" class="view-section hidden">
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Vouchers</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="btnDeleteVouchers" class="btn-cancel hidden"
                            onclick="deleteSelectedVouchers()">Delete Selected</button>
                        <button class="btn-submit"
                            onclick="loadPackagesForImport(); openDashModal('importVoucherModal')">Import
                            Vouchers</button>
                    </div>
                </div>
                <div class="table-responsive table-scroll-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAllVoucherCb"
                                        onclick="toggleAllVouchers(this)"></th>
                                <th>Code</th>
                            </tr>
                        </thead>
                        <tbody id="vouchersTableBody">
                            <!-- JS renders rows here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments View (Hidden by default) -->
            <div id="paymentsView" class="view-section hidden">
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Transaction History</h2>
                    <button class="btn-submit" onclick="fetchPaymentsList()">Refresh</button>
                </div>
                <div class="table-responsive table-scroll-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Phone</th>
                                <th>Amount</th>
                                <th>Package</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Ref</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <!-- JS renders rows here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SMS Logs View (Hidden by default) -->
            <div id="smsView" class="view-section hidden">
                <div class="content-header">
                    <h2>SMS Logs</h2>
                </div>
                <div class="table-responsive table-scroll-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Phone</th>
                                <th>Message</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="smsTableBody">
                            <!-- JS renders rows here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals (Add Category/Package) -->
    <!-- Same modals as before... -->

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content">
            <h3>Add Category</h3>
            <input type="text" id="newCatName" placeholder="Category Name (e.g., Daily Bundles)">
            <div class="modal-actions">
                <button onclick="createCategory()" class="btn-save">Save</button>
                <button onclick="closeDashModal('addCategoryModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>
    <!-- ... -->

    <!-- ... -->


    <!-- Add Package Modal -->
    <div id="addPackageModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content">
            <h3>Add Package</h3>
            <input type="number" id="pkgPrice" placeholder="Price (UGX)">
            <select id="pkgCategory">
                <option value="">Select Category</option>
            </select>
            <div class="modal-actions">
                <button onclick="createPackage()" class="btn-save">Save</button>
                <button onclick="closeDashModal('addPackageModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Voucher Modal -->
    <div id="importVoucherModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content">
            <h3>Import Vouchers</h3>
            <div style="margin-bottom: 15px; font-size: 0.9rem; color: #ccc;">
                Select a package and upload a CSV file containing voucher codes (one per line).
            </div>
            <select id="importPackageId">
                <option value="">Select Package</option>
            </select>
            <input type="file" id="voucherCsv" accept=".csv" style="padding: 10px; background: #333; color: white;">

            <div class="modal-actions">
                <button onclick="importVouchers()" class="btn-save">Upload</button>
                <button onclick="closeDashModal('importVoucherModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Sell Voucher Modal -->
    <div id="sellVoucherModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content">
            <h3>Sell Voucher</h3>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">Send a voucher via SMS.</p>

            <select id="sellPackageId" style="width: 100%; margin-bottom: 15px; padding: 10px;">
                <option value="">Select Package</option>
            </select>

            <input type="text" id="sellPhone" placeholder="Recipient Phone (+256...)"
                style="width: 100%; padding: 10px; margin-bottom: 15px;">

            <div class="modal-actions">
                <button onclick="submitSellVoucher()" class="btn-save">Send SMS</button>
                <button onclick="closeDashModal('sellVoucherModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePassModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content">
            <h3>Change Password</h3>
            <input type="password" id="currentPass" placeholder="Current Password"
                style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <input type="password" id="newPass" placeholder="New Password"
                style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <input type="password" id="confirmPass" placeholder="Confirm New Password"
                style="width: 100%; padding: 10px; margin-bottom: 15px;">

            <div class="modal-actions">
                <button onclick="submitChangePass()" class="btn-save">Update</button>
                <button onclick="closeDashModal('changePassModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="dashboard-modal hidden" style="z-index: 9999;">
        <div class="alert-modal-content">
            <h3 id="customAlertTitle" class="alert-title">Alert</h3>
            <p id="customAlertMessage" class="alert-message">Message goes here.</p>
            <div id="customAlertActions">
                <button onclick="closeCustomAlert()" class="alert-btn success">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="customConfirmModal" class="dashboard-modal hidden" style="z-index: 9999;">
        <div class="alert-modal-content">
            <h3 id="customConfirmTitle" class="alert-title">Confirm</h3>
            <p id="customConfirmMessage" class="alert-message">Are you sure?</p>
            <div>
                <button id="confirmCancelBtn" class="alert-btn cancel">Cancel</button>
                <button id="confirmOkBtn" class="alert-btn success">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Buy SMS Modal -->
    <div id="buySMSModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content">
            <h3 class="modal-title">Buy SMS Credits</h3>
            <div class="form-group">
                <label>Phone Number (MoMo)</label>
                <input type="text" id="smsPhone" placeholder="07XX XXX XXX">
            </div>
            <div class="form-group">
                <label>Amount (UGX)</label>
                <input type="number" id="smsAmount" placeholder="Enter amount" min="500">
            </div>

            <!-- Inline Progress Bar (Hidden by default) -->
            <div id="smsProgressBarContainer" style="display:none; margin-top:20px; text-align:center;">
                <p style="font-size:0.9em; color:#666; margin-bottom:10px;">Waiting for Payment...</p>
                <div style="width:100%; height:8px; background:#f0f0f0; border-radius:4px; overflow:hidden;">
                    <div id="smsProgressBar"
                        style="width:0%; height:100%; background:#4caf50; transition:width 0.5s ease;"></div>
                </div>
                <p style="font-size:0.8em; color:#999; margin-top:5px;">Check your phone to approve</p>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeDashModal('buySMSModal')">Cancel</button>
                <button class="btn-submit" onclick="submitBuySMS()">Pay & Topup</button>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content">
            <h3 class="modal-title">Withdraw Funds</h3>
            <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">Transfer funds from your Wallet to Mobile
                Money.</p>

            <div class="form-group">
                <label>Amount (UGX)</label>
                <input type="number" id="withdrawAmount" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="text" id="withdrawPhone" placeholder="07XX XXX XXX">
            </div>
            <div class="form-group">
                <label>Description (Optional)</label>
                <input type="text" id="withdrawDesc" placeholder="Reason for withdrawal">
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeDashModal('withdrawModal')">Cancel</button>
                <button class="btn-submit" onclick="submitWithdrawal()">Withdraw</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="dashboard-modal hidden">
        <div class="dashboard-modal-content success-content">
            <div class="success-header">
                <img src="img/favicon.png" alt="WiPay Logo" class="success-logo">
            </div>
            <div class="success-icon">
                <div class="checkmark-circle">
                    <div class="background"></div>
                    <div class="checkmark draw"></div>
                </div>
            </div>
            <h3 class="success-title">Success!</h3>
            <p id="successMessage" class="success-message">
                <!-- Voucher (CODE) has been sent successfully to (PHONE). -->
            </p>
            <div class="modal-actions center-actions">
                <button onclick="closeDashModal('successModal')" class="btn-save">OK</button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // --- Custom Alert/Confirm Logic ---
        function showAlert(message, type = 'success') {
            const modal = document.getElementById('customAlertModal');
            const title = document.getElementById('customAlertTitle');
            const msg = document.getElementById('customAlertMessage');
            const btn = modal.querySelector('button');

            title.textContent = type === 'success' ? 'Success' : 'Error';
            title.style.color = type === 'success' ? '#4caf50' : '#f44336';
            msg.textContent = message;

            btn.className = `alert-btn ${type}`;
            btn.onclick = () => modal.classList.add('hidden');

            modal.classList.remove('hidden');
        }

        function closeCustomAlert() {
            document.getElementById('customAlertModal').classList.add('hidden');
        }

        function showConfirm(message, callback) {
            const modal = document.getElementById('customConfirmModal');
            const msg = document.getElementById('customConfirmMessage');
            const okBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');

            msg.textContent = message;

            // Remove old listeners
            const newOk = okBtn.cloneNode(true);
            const newCancel = cancelBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOk, okBtn);
            cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

            newOk.onclick = () => {
                modal.classList.add('hidden');
                if (callback) callback(true);
            };

            newCancel.onclick = () => {
                modal.classList.add('hidden');
            };

            modal.classList.remove('hidden');
        }

        // --- Auth Helper ---
        async function fetchAuth(url, options = {}) {
            let token = localStorage.getItem('wipay_token');
            if (!token) {
                window.location.href = 'login.html';
                return Promise.reject('No token');
            }

            // Aggressive Sanitization: Remove any non-printable ASCII characters
            token = token.replace(/[^\x20-\x7E]/g, '').trim();

            let headers = {
                'Authorization': `Bearer ${token}`
            };

            // Merge options.headers safely
            if (options.headers) {
                for (const [key, value] of Object.entries(options.headers)) {
                    headers[key] = value;
                }
            }

            // If using FormData, let browser set Content-Type header
            if (options.body instanceof FormData) {
                delete headers['Content-Type'];
            }

            const newOptions = { ...options, headers };

            // Handle URL
            const fullUrl = url.startsWith('/api') ? url.replace('/api', CONFIG.API_BASE_URL) : url;

            try {
                const response = await fetch(fullUrl, newOptions);

                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('wipay_token');
                    window.location.href = 'login.html';
                    return Promise.reject('Unauthorized');
                }
                return response;
            } catch (e) {
                console.error('FetchAuth Error:', e);
                // If it is a header error, retry without custom headers just to test? No, auth is needed.
                throw e;
            }
        }

        function submitBuySMS() {
            const amount = document.getElementById('smsAmount').value;
            const phone = document.getElementById('smsPhone').value;

            if (!amount || Number(amount) < 500) {
                showAlert('Please enter a valid amount (Min 500)');
                return;
            }
            if (!phone || phone.trim().length < 10) {
                showAlert('Please enter a valid phone number (e.g. 0770000000)');
                return;
            }

            // Elements
            const actionsDiv = document.querySelector('#buySMSModal .modal-actions');
            const loadingDiv = document.getElementById('smsProgressBarContainer');
            const progressBar = document.getElementById('smsProgressBar');
            const btn = document.querySelector('#buySMSModal .btn-submit');
            const originalText = btn.innerText;

            // UI: Start Loading
            actionsDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            progressBar.style.width = '10%'; // Start

            fetchAuth(`${CONFIG.API_BASE_URL}/admin/buy-sms`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: Number(amount), phone_number: phone.trim() })
            })
                .then(async res => {
                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({}));
                        throw new Error(errorData.error || errorData.message || 'Purchase failed');
                    }
                    const data = await res.json();

                    if (data.status === 'pending') {
                        // Enter Polling Mode
                        let progress = 10;
                        const pollInterval = setInterval(async () => {
                            // Animate Progress (Fake up to 90%)
                            if (progress < 90) {
                                progress += (Math.random() * 5);
                                progressBar.style.width = `${progress}%`;
                            }

                            try {
                                const checkRes = await fetchAuth(`${CONFIG.API_BASE_URL}/admin/sms-status/${data.reference}`);
                                if (!checkRes.ok) return;
                                const checkData = await checkRes.json();

                                if (checkData.status === 'success') {
                                    clearInterval(pollInterval);
                                    progressBar.style.width = '100%';

                                    setTimeout(() => {
                                        closeDashModal('buySMSModal');
                                        // Reset UI for next time
                                        actionsDiv.style.display = 'flex'; // or block/flex
                                        loadingDiv.style.display = 'none';

                                        // Update Data
                                        loadStats();
                                        loadSMSBalance();

                                        const successMsg = `SMS Purchase of <strong>${Number(amount).toLocaleString()} UGX</strong> Successful! Reference: ${escapeHtml(data.reference)}`;
                                        document.getElementById('successMessage').innerHTML = successMsg;
                                        openDashModal('successModal');
                                    }, 500);

                                } else if (checkData.status === 'failed') {
                                    clearInterval(pollInterval);
                                    // User requested: Display the same error as timeout
                                    showAlert('Payment check timed out. Please check your phone.', 'error');
                                    // Reset UI
                                    actionsDiv.style.display = 'flex';
                                    loadingDiv.style.display = 'none';
                                }
                            } catch (e) { console.error('Polling error', e); }
                        }, 2000);

                        // Timeout after 5 mins (300,000ms) - User requested
                        setTimeout(() => {
                            if (loadingDiv.style.display === 'block') { // If still loading
                                clearInterval(pollInterval);
                                actionsDiv.style.display = 'flex';
                                loadingDiv.style.display = 'none';
                                loadStats(); loadSMSBalance();
                                showAlert('Payment check timed out. Please check your phone.', 'error');
                            }
                        }, 300000);

                    } else {
                        // Immediate Success
                        closeDashModal('buySMSModal');
                        actionsDiv.style.display = 'flex';
                        loadingDiv.style.display = 'none';
                        loadStats();
                        loadSMSBalance();
                        const successMsg = `SMS Purchase Confirmed! Balance: ${data.balance}`;
                        document.getElementById('successMessage').innerHTML = successMsg;
                        openDashModal('successModal');
                    }
                })
                .catch(err => {
                    console.error('Submit SMS Error:', err);
                    showAlert(err.message || 'Purchase failed', 'error');
                    actionsDiv.style.display = 'flex';
                    loadingDiv.style.display = 'none';
                });
        }

        // --- Logout ---
        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.onclick = (e) => {
                e.preventDefault();
                localStorage.removeItem('wipay_token');
                window.location.href = 'login.html';
            };
        }

        // --- Modal Logic ---
        function openDashModal(id) {
            document.getElementById(id).classList.remove('hidden');
            if (id === 'addPackageModal') loadCategoriesForSelect();
            if (id === 'importVoucherModal') loadPackagesForSelect('importPackageId');
            if (id === 'sellVoucherModal') loadPackagesForSelect('sellPackageId');
        }

        function closeDashModal(id) {
            document.getElementById(id).classList.add('hidden');
        }


        // --- Category Logic ---
        async function createCategory() {
            const name = document.getElementById('newCatName').value;
            if (!name) return showAlert('Enter name', 'error');

            try {
                const res = await fetchAuth('/api/admin/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    closeDashModal('addCategoryModal');
                    showAlert('Category Created!', 'success');
                    loadStats();
                    showAlert('Category Created!', 'success');
                    loadStats();
                    forceReload('categories');
                } else {
                    showAlert('Failed to create category', 'error');
                }
            } catch (e) {
                console.error(e);
            }
        }

        // --- Package Logic ---
        async function loadCategoriesForSelect() {
            try {
                const res = await fetchAuth('/api/admin/categories');
                const cats = await res.json();
                const select = document.getElementById('pkgCategory');
                select.innerHTML = '<option value="">Select Category</option>';
                cats.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function createPackage() {
            const categorySelect = document.getElementById('pkgCategory');
            const data = {
                name: categorySelect.options[categorySelect.selectedIndex]?.text || 'Unknown Package',
                price: document.getElementById('pkgPrice').value,
                validity_hours: null, // Removed from UI
                data_limit_mb: null,  // Removed from UI
                category_id: categorySelect.value
            };

            if (!data.price || !data.category_id) return showAlert('Please fill required fields', 'error');

            const res = await fetchAuth('/api/admin/packages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                closeDashModal('addPackageModal');
                loadStats();
                fetchPackagesList();
                showAlert('Package Created!', 'success');
            } else {
                showAlert('Failed to create package', 'error');
            }
        }

        async function loadPackagesForImport() {
            try {
                const res = await fetchAuth('/api/admin/packages');
                const packages = await res.json();
                const select = document.getElementById('importPackageId');
                select.innerHTML = '<option value="">Select Package</option>';
                packages.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = `${p.name} (${Number(p.price).toLocaleString()} UGX)`;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error(e);
            }
        }

        async function loadPackagesForSell() {
            try {
                const res = await fetchAuth('/api/admin/packages');
                const packages = await res.json();
                const select = document.getElementById('sellPackageId');
                select.innerHTML = '<option value="">Select Package</option>';
                packages.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = `${p.name} (${Number(p.price).toLocaleString()} UGX)`;
                    select.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function importVouchers() {
            const pkgId = document.getElementById('importPackageId').value;
            const fileInput = document.getElementById('voucherCsv');
            const file = fileInput.files[0];

            if (!pkgId) return showAlert('Select a package', 'error');
            if (!file) return showAlert('Select a CSV file', 'error');

            const formData = new FormData();
            formData.append('package_id', pkgId);
            formData.append('file', file);

            try {
                const res = await fetchAuth('/api/admin/vouchers/import', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();
                if (res.ok) {
                    showAlert(data.message, 'success');
                    closeDashModal('importVoucherModal');
                    loadStats();
                    fetchVouchersList();
                } else {
                    showAlert(data.error || 'Import failed', 'error');
                }
            } catch (e) {
                console.error(e);
                showAlert('Upload error', 'error');
            }
        }

        // --- Global State ---
        let currentSMSBalance = 0;

        // --- View Switching Logic ---
        const views = {
            'dashboard': document.getElementById('dashboardView'),
            'categories': document.getElementById('categoriesView'),
            'packages': document.getElementById('packagesView'),
            'vouchers': document.getElementById('vouchersView'),
            'payments': document.getElementById('paymentsView'),
            'sms': document.getElementById('smsView')
        };

        // Caching State
        const loadedViews = {
            categories: false,
            packages: false,
            vouchers: false,
            payments: false,
            sms: false,
            dashboard: false
        };

        const breadcrumbMap = {
            'dashboard': 'Home > Dashboard',
            'categories': 'Home > Dashboard > Categories',
            'packages': 'Home > Dashboard > Packages',
            'vouchers': 'Home > Dashboard > Vouchers',
            'payments': 'Home > Dashboard > Payments',
            'sms': 'Home > Dashboard > SMS Logs'
        };

        function switchView(viewName) {
            // Hide all views
            Object.values(views).forEach(el => el.classList.add('hidden'));

            // Show selected view
            const selected = views[viewName];
            if (selected) {
                selected.classList.remove('hidden');

                // Update Breadcrumb
                const bc = document.querySelector('.breadcrumb');
                if (breadcrumbMap[viewName]) bc.innerText = breadcrumbMap[viewName];

                // Load Data only if not loaded yet (Basic Caching)
                // Dashboard stats always refresh for now, or we can debounce it
                if (viewName === 'dashboard') loadStats(); // Keep dashboard fresh

                if (viewName === 'categories' && !loadedViews.categories) { fetchCategoriesList(); loadedViews.categories = true; }
                if (viewName === 'packages' && !loadedViews.packages) { fetchPackagesList(); loadedViews.packages = true; }
                if (viewName === 'vouchers' && !loadedViews.vouchers) { fetchVouchersList(); loadedViews.vouchers = true; }
                if (viewName === 'payments' && !loadedViews.payments) { fetchPaymentsList(); loadedViews.payments = true; }
                if (viewName === 'sms' && !loadedViews.sms) { fetchSMSLogs(); loadedViews.sms = true; }

                // Highlight Active Nav
                document.querySelectorAll('.sidebar-nav li, .mobile-nav-btn').forEach(el => {
                    el.classList.remove('active');
                    if (el.getAttribute('data-view') === viewName) {
                        el.classList.add('active');
                    }
                });
            }
        }

        // Helper to force reload (e.g. after adding item)
        function forceReload(viewName) {
            if (loadedViews[viewName] !== undefined) loadedViews[viewName] = false;
            // Also reload if currently active
            if (!document.getElementById(viewName + 'View').classList.contains('hidden')) {
                if (viewName === 'categories') fetchCategoriesList();
                if (viewName === 'packages') fetchPackagesList();
                if (viewName === 'vouchers') fetchVouchersList();
                if (viewName === 'payments') fetchPaymentsList();
                if (viewName === 'sms') fetchSMSLogs();
                loadedViews[viewName] = true;
            }
        }

        // --- Fetch Lists ---
        async function fetchSMSLogs() {
            try {
                const res = await fetchAuth('/api/admin/sms-logs');
                const logs = await res.json();
                const tbody = document.getElementById('smsTableBody');
                tbody.innerHTML = '';

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888;">No SMS logs found.</td></tr>';
                    return;
                }

                logs.forEach(log => {
                    const statusColor = log.status === 'success' ? '#4caf50' : (log.status === 'pending' ? '#ff9800' : '#f4436');
                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(log.created_at).toLocaleString()}</td>
                            <td>${log.phone_number}</td>
                            <td>${log.message}</td>
                            <td style="color: ${statusColor}; font-weight: 500;">${log.status.toUpperCase()}</td>
                        </tr>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        async function deleteCategory(id, name) {
            showConfirm(`⚠️ WARNING: Deleting category "${name}" will PERMANENTLY DELETE all linked Packages and Vouchers. Are you sure?`, async (confirmed) => {
                if (confirmed) {
                    try {
                        const res = await fetchAuth(`/api/admin/categories/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            showAlert('Category deleted', 'success');
                            fetchCategoriesList();
                            loadStats(); // refresh counts
                        } else {
                            const err = await res.json();
                            showAlert(err.error || 'Failed to delete', 'error');
                        }
                    } catch (e) {
                        console.error(e);
                        showAlert('Connection error', 'error');
                    }
                }
            });
        }

        async function fetchCategoriesList() {
            try {
                const res = await fetchAuth('/api/admin/categories');
                const rows = await res.json();
                const tbody = document.getElementById('categoriesTableBody');
                tbody.innerHTML = '';
                rows.forEach(r => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${r.name}</td>
                            <td><button class="btn-cancel" onclick="deleteCategory(${r.id}, '${r.name.replace(/'/g, "\\'")}')" style="padding:4px 8px; font-size:0.7rem;">Delete</button></td>
                        </tr>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        async function fetchPackagesList() {
            try {
                const res = await fetchAuth('/api/admin/packages');
                const packs = await res.json();
                const tbody = document.getElementById('packagesTableBody');
                tbody.innerHTML = '';
                packs.forEach(p => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${p.name}</td>
                            <td>${Number(p.price).toLocaleString()} UGX</td>
                            <td>${p.validity_hours} Hours</td>
                            <td>${p.category_name || '-'}</td>
                        </tr>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        async function fetchVouchersList() {
            try {
                const res = await fetchAuth('/api/admin/vouchers');
                const vouchers = await res.json();
                const tbody = document.getElementById('vouchersTableBody');
                tbody.innerHTML = '';

                if (vouchers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color: #888;">No available vouchers found.</td></tr>';
                    return;
                }

                vouchers.forEach(v => {
                    const uniqueId = `v-details-${v.id}`;
                    tbody.innerHTML += `
                        <tr onclick="toggleVoucherRow('${uniqueId}')" style="cursor: pointer;">
                            <td onclick="event.stopPropagation()">
                                <input type="checkbox" class="voucher-cb" value="${v.id}" onchange="checkVoucherSelection()">
                            </td>
                            <td style="font-weight: bold; color: #03a9f4;">
                                <span style="margin-right: 10px;">▶</span> ${v.code}
                            </td>
                        </tr>
                        <tr id="${uniqueId}" class="hidden" style="background: #222;">
                            <td></td>
                            <td style="padding: 15px 25px; border-bottom: 2px solid #444;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                                    <div><strong>Package:</strong> ${v.package_name}</div>
                                    <div><strong>Ref:</strong> <span style="color: #bbb;">${v.package_ref || '-'}</span></div>
                                    <div><strong>Created:</strong> ${new Date(v.created_at).toLocaleDateString()}</div>
                                    <div><strong>Status:</strong> Available</div>
                                    <div style="grid-column: span 2;">
                                        <strong>Comment:</strong> <span style="color: #bbb;">${v.comment || '-'}</span>
                                    </div>
                                    <div style="grid-column: span 2; margin-top: 5px;">
                                        <button class="btn-cancel" style="font-size: 0.8rem; padding: 4px 8px;" onclick="deleteSingleVoucher(${v.id})">Delete</button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        function toggleVoucherRow(id) {
            const row = document.getElementById(id);
            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        }

        function toggleAllVouchers(source) {
            const cbs = document.querySelectorAll('.voucher-cb');
            cbs.forEach(cb => cb.checked = source.checked);
            checkVoucherSelection();
        }

        function checkVoucherSelection() {
            const checkedCount = document.querySelectorAll('.voucher-cb:checked').length;
            const btn = document.getElementById('btnDeleteVouchers');
            if (checkedCount > 0) {
                btn.classList.remove('hidden');
                btn.textContent = `Delete Selected (${checkedCount})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        // ... (Voucher Delete Logic)
        async function deleteSelectedVouchers() {
            const checked = document.querySelectorAll('.voucher-cb:checked');
            if (checked.length === 0) return;

            showConfirm(`Are you sure you want to delete ${checked.length} vouchers?`, async () => {
                const ids = Array.from(checked).map(cb => cb.value);

                try {
                    const res = await fetchAuth('/api/admin/vouchers', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids })
                    });

                    if (res.ok) {
                        showAlert('Vouchers deleted successfully', 'success');
                        forceReload('vouchers');
                        document.getElementById('btnDeleteVouchers').classList.add('hidden');
                        document.getElementById('selectAllVoucherCb').checked = false;
                        fetchDashboardStats();
                    } else {
                        showAlert('Failed to delete vouchers', 'error');
                    }
                } catch (e) { console.error(e); }
            });
        }

        async function deleteSingleVoucher(id) {
            showConfirm('Delete this voucher?', async () => {
                try {
                    const res = await fetchAuth('/api/admin/vouchers', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: [id] })
                    });
                    if (res.ok) { forceReload('vouchers'); fetchDashboardStats(); }
                } catch (e) { console.error(e); }
            });
        }

        // ... (Import/Sell Logic)
        async function submitSellVoucher() {
            const pkgId = document.getElementById('sellPackageId').value;
            const phone = document.getElementById('sellPhone').value;

            if (!pkgId || !phone) return showAlert('Select package and enter phone number', 'error');

            if (currentSMSBalance < 35) {
                return showAlert(`Insufficient SMS Balance (${currentSMSBalance} UGX). Please top up.`, 'error');
            }

            showConfirm(`Send voucher for selected package to ${phone}?`, async () => {
                try {
                    const res = await fetchAuth('/api/admin/sell-voucher', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ package_id: pkgId, phone_number: phone })
                    });

                    const data = await res.json();
                    if (res.ok) {
                        closeDashModal('sellVoucherModal');
                        loadStats();
                        loadStats();
                        forceReload('vouchers');
                        fetchSMSLogs();
                        // Special Success Modal for Sell Voucher (keep existing one as it is specific)
                        document.getElementById('successMessage').textContent = `Voucher sent to ${phone}.`;
                        openDashModal('successModal');
                    } else {
                        showAlert(data.error || 'Failed', 'error');
                    }
                } catch (e) { console.error(e); }
            });
        }




        async function submitChangePass() {
            const curr = document.getElementById('currentPass').value;
            const newP = document.getElementById('newPass').value;
            const conf = document.getElementById('confirmPass').value;

            if (!curr || !newP || !conf) return showAlert('All fields required', 'error');
            if (newP !== conf) return showAlert('New passwords do not match', 'error');

            try {
                const res = await fetchAuth('/api/admin/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword: curr, newPassword: newP })
                });

                const data = await res.json();
                if (res.ok) {
                    showAlert('Password Updated! Please login again.', 'success');
                    setTimeout(() => {
                        localStorage.removeItem('wipay_token');
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showAlert(data.error || 'Failed to update password', 'error');
                }
            } catch (e) {
                console.error(e);
                showAlert('Connection Error', 'error');
            }
        }

        // Attach Event Listeners to Sidebar Links
        document.addEventListener('DOMContentLoaded', () => {
            // Set Username
            const user = localStorage.getItem('wipay_user');
            if (user) {
                document.getElementById('welcomeMsg').textContent = `WELCOME, ${escapeHtml(user)}`;
            }

            // Dashboard Home
            document.querySelector('.breadcrumb').addEventListener('click', () => switchView('dashboard'));

            // Add Buttons Logic
            const addBtns = document.querySelectorAll('.add-btn');
            addBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // Stop parent link click
                    const parentText = btn.parentElement.innerText;
                    if (parentText.includes('Categories')) openDashModal('addCategoryModal');
                    if (parentText.includes('Packages')) openDashModal('addPackageModal');
                });
            });
            loadStats();
            loadSMSBalance(); // Dedicated call
        });

        // Fetch SMS Balance (Separate)
        async function loadSMSBalance() {
            const balEl = document.getElementById('sms-balance');
            try {
                balEl.textContent = 'Loading...';
                const res = await fetchAuth('/api/admin/sms-balance');
                const data = await res.json();

                if (data.balance !== undefined && data.balance !== null) {
                    const val = Math.max(0, Number(data.balance));
                    currentSMSBalance = val;
                    balEl.textContent = `SMS: ${val}`;
                } else {
                    balEl.textContent = 'SMS: N/A';
                }
            } catch (err) {
                console.error('Failed to load SMS Balance', err);
                balEl.textContent = 'SMS: Error';
                balEl.style.color = '#e74c3c'; // Red for error
            }
        }

        // Fetch Admin Stats
        async function loadStats() {
            try {
                const res = await fetchAuth('/api/admin/stats');
                const data = await res.json();

                if (data.finance) {
                    // SMS Balance handled separately now

                    document.getElementById('daily-trans').textContent = Number(data.finance.daily_revenue).toLocaleString();
                    document.getElementById('weekly-trans').textContent = Number(data.finance.weekly_revenue).toLocaleString();
                    document.getElementById('monthly-trans').textContent = Number(data.finance.monthly_revenue).toLocaleString();
                    document.getElementById('yearly-trans').textContent = Number(data.finance.yearly_revenue).toLocaleString();
                    document.getElementById('total-trans').textContent = Number(data.finance.total_revenue).toLocaleString();

                    document.getElementById('balance').textContent = Number(data.finance.total_revenue).toLocaleString();

                    // Check Subscription
                    checkSubscriptionStatus(data.subscription);
                }

                if (data.counts) {
                    document.getElementById('cat-count').textContent = data.counts.categories_count;
                    document.getElementById('pkg-count').textContent = data.counts.packages_count;
                    document.getElementById('voucher-count').textContent = data.counts.vouchers_count;
                    document.getElementById('bought-vouchers').textContent = data.counts.bought_vouchers_count;
                    document.getElementById('payments-count').textContent = data.counts.payments_count;
                }

            } catch (err) {
                console.error('Failed to load stats', err);
                // Set errors on key elements
                // Set errors on key elements
                document.getElementById('balance').textContent = 'Error';
            }
        }

        function checkSubscriptionStatus(sub) {
            // Remove existing clean up
            const existingAlert = document.getElementById('sub-alert');
            if (existingAlert) existingAlert.remove();

            if (!sub || sub.billing_type !== 'subscription') return;
            if (!sub.subscription_expiry) return; // Assume infinite if null?

            const expiry = new Date(sub.subscription_expiry);
            const now = new Date();
            const diffMs = expiry - now;
            const diffDays = diffMs / (1000 * 60 * 60 * 24);

            if (diffMs < 0) {
                // EXPIRED - Show Banner instead of Blocker
                showExpiryBanner(expiry);
            } else if (diffDays <= 2) {
                // WARNING
                showSubscriptionWarning(diffDays, expiry);
            }
        }

        function showExpiryBanner(date) {
            // Remove existing banner if any
            const existing = document.getElementById('expiry-banner');
            if (existing) existing.remove();

            const banner = document.createElement('div');
            banner.id = 'expiry-banner';
            // Use lighter colors and auto width to match parent padding
            banner.style.cssText = `
                background: #ffcdd2;
                color: #c62828;
                padding: 10px;
                text-align: center;
                font-weight: 500;
                font-size: 0.9rem;
                margin-bottom: 15px;
                border-radius: 4px;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            `;
            banner.innerHTML = `<i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i> <strong>SUBSCRIPTION EXPIRED:</strong> Client packages are hidden. Please renew.`;

            // Insert at the top of main-content (pushes header down)
            const content = document.querySelector('.main-content');
            if (content) {
                content.insertBefore(banner, content.firstChild);
            }
        }

        function showSubscriptionWarning(days, date) {
            const div = document.createElement('div');
            div.id = 'sub-alert';
            div.style.cssText = `
                background: #ff9800; color: #000; padding: 15px;
                text-align: center; font-weight: bold;
                position: fixed; bottom: 20px; right: 20px; z-index: 9000;
                border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            `;
            const daysLeft = Math.ceil(days);
            div.innerHTML = `
                ⚠ Subscription expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''} (${date.toLocaleDateString()}).
                <button onclick="this.parentElement.remove()" style="margin-left: 10px; background:none; border:none; cursor:pointer; font-weight:bold;">✕</button>
            `;
            document.body.appendChild(div);
        }

        async function submitWithdrawal() {
            const phone = document.getElementById('withdrawPhone').value;
            const amount = document.getElementById('withdrawAmount').value;
            const desc = document.getElementById('withdrawDesc').value;

            if (!phone || !amount) {
                showAlert('Please enter phone number and amount.', 'error');
                return;
            }

            // Using custom confirm modal
            showConfirm(`Are you sure you want to withdraw UGX ${Number(amount).toLocaleString()} to ${escapeHtml(phone)}?`, async () => {
                try {
                    const res = await fetchAuth('/api/admin/withdraw', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone_number: phone, amount: amount, description: desc })
                    });

                    const data = await res.json();
                    if (res.ok) {
                        closeDashModal('withdrawModal');
                        loadStats();

                        // Show Success Popup
                        const successMsg = `Withdrawal of <strong>${Number(amount).toLocaleString()} UGX</strong> has been successfully initiated to <strong>${escapeHtml(phone)}</strong>. Reference: ${escapeHtml(data.data.reference || 'N/A')}`;
                        document.getElementById('successMessage').innerHTML = successMsg;
                        openDashModal('successModal');
                    } else {
                        showAlert('Withdrawal Failed: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showAlert('Error processing withdrawal.', 'error');
                }
            });
        }

        // Refresh every 10 seconds (Smart Refresh)
        setInterval(() => {
            loadStats();
            loadSMSBalance();

            // Refresh Active Table
            if (!document.getElementById('categoriesView').classList.contains('hidden')) fetchCategoriesList();
            if (!document.getElementById('packagesView').classList.contains('hidden')) fetchPackagesList();
            if (!document.getElementById('vouchersView').classList.contains('hidden')) fetchVouchersList();
            if (!document.getElementById('paymentsView').classList.contains('hidden')) fetchPaymentsList();
            if (!document.getElementById('smsView').classList.contains('hidden')) fetchSMSLogs();
        }, 10000);

        async function fetchPaymentsList() {
            try {
                const res = await fetchAuth('/api/admin/transactions');
                const txs = await res.json();
                const tbody = document.getElementById('paymentsTableBody');
                tbody.innerHTML = '';

                if (txs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: #888;">No transactions found.</td></tr>';
                    return;
                }

                txs.forEach(t => {
                    const statusColor = t.status === 'success' ? '#4caf50' : '#f44336';
                    const method = t.payment_method === 'manual' ? '<span class="badge bg-secondary">Manual</span>' : '<span class="badge bg-primary">MoMo</span>';

                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(t.created_at).toLocaleString()}</td>
                            <td>${escapeHtml(t.phone_number)}</td>
                            <td>${Number(t.amount).toLocaleString()} UGX</td>
                            <td>${escapeHtml(t.package_name || '-')}</td>
                            <td>${method}</td>
                            <td style="color: ${statusColor}; font-weight: 500;">${escapeHtml(t.status.toUpperCase())}</td>
                            <td><small style="color:#aaa">${escapeHtml(t.transaction_ref)}</small></td>
                        </tr>
                    `;
                });
            } catch (e) { console.error(e); }

        }

        // --- Mobile Sidebar Toggle ---
        // --- Sidebar Logic ---
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('open');
        }

        // Desktop Sidebar Toggle
        function toggleDesktopSidebar() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        }

        function initMobileMenus() {
            const sidebar = document.querySelector('.sidebar');
            const links = document.querySelectorAll('.sidebar-nav li a');
            const hamburger = document.querySelector('.mobile-menu-btn');

            // Close sidebar when clicking any link
            links.forEach(l => {
                l.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                    }
                });
            });

            // Close sidebar when clicking outside
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                    // If click is NOT inside sidebar AND NOT the hamburger button
                    if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
                        sidebar.classList.remove('open');
                    }
                }
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initMobileMenus();
            checkSubscriptionStatus();
        });

        const SUB_RATE = 20000;

        function updateSubAmount() {
            const months = document.getElementById('subDuration').value;
            const total = months * SUB_RATE;
            document.getElementById('subAmountDisplay').innerText = total.toLocaleString() + ' UGX';
        }

        // Generic Toast Notification
        function showToast(msg, type = 'info') {
            const div = document.createElement('div');
            const bg = type === 'error' ? '#f44336' : '#333';
            div.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 20000;
                background: ${bg}; color: white; padding: 12px 20px;
                border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                font-weight: 500; font-size: 0.95rem; opacity: 0;
                transform: translateY(-20px); transition: all 0.3s ease;
            `;
            div.textContent = msg;
            document.body.appendChild(div);

            // Animate In
            setTimeout(() => {
                div.style.opacity = '1';
                div.style.transform = 'translateY(0)';
            }, 10);

            // Remove after 3s
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateY(-20px)';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        async function initiateSubscription() {
            const phone = document.getElementById('subPhone').value;
            const months = document.getElementById('subDuration').value;
            const amount = months * SUB_RATE;

            if (!phone) {
                showToast('Please enter a phone number', 'error');
                return;
            }

            // 1. Close Subscription Form
            closeDashModal('subscriptionModal');

            // 2. Open Processing Modal
            openDashModal('processingModal');

            // 3. Initialize Progress Bar (Start at 10%)
            const progressBar = document.querySelector('#processingModal #progressBar div');
            if (progressBar) progressBar.style.width = '10%';

            try {
                const res = await fetchAuth('/api/admin/renew-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: phone, months: parseInt(months), amount: amount })
                });

                const data = await res.json();

                if (res.ok) {
                    // Start Polling
                    pollSubscription(data.reference);
                } else {
                    closeDashModal('processingModal');
                    showAlert(data.error || 'Payment Failed', 'error');
                }
            } catch (e) {
                console.error(e);
                closeDashModal('processingModal');
                showAlert('Connection Error', 'error');
            }
        }

        function resetSubBtn() {
            const btn = document.getElementById('btnPaySub');
            btn.disabled = false;
            btn.innerText = 'Pay Now';
            document.getElementById('subStatusMsg').innerText = '';
        }

        async function pollSubscription(ref) {
            let attempts = 0;
            const maxAttempts = 60; // 3 mins (since 3s interval)

            const interval = setInterval(async () => {
                attempts++;

                // Smart Progress Logic: Incremental updates
                const progressElement = document.querySelector('#processingModal #progressBar div');
                if (progressElement) {
                    const currentWidth = parseFloat(progressElement.style.width) || 10;
                    if (currentWidth < 95) {
                        // Increment by ~1.4% per tick to reach 95% in ~60 ticks
                        progressElement.style.width = (currentWidth + 1.4) + '%';
                    }
                }

                try {
                    const res = await fetchAuth(`/api/admin/subscription-status/${ref}`);
                    const data = await res.json();

                    if (data.status === 'success') {
                        clearInterval(interval);

                        // Fill to 100% on success
                        if (progressElement) progressElement.style.width = '100%';

                        // Short delay before success modal
                        setTimeout(() => {
                            closeDashModal('processingModal');
                            resetSubBtn();

                            // Hide banner immediately if shown
                            const banner = document.getElementById('expiryBanner');
                            if (banner) banner.style.display = 'none';

                            document.getElementById('successMessage').innerHTML = `
                                <strong>Subscription Renewed!</strong><br>
                                Your account is now active. Thank you!
                            `;
                            openDashModal('successModal');
                        }, 500);

                    } else if (data.status === 'failed') {
                        clearInterval(interval);
                        closeDashModal('processingModal');
                        showAlert('Payment was declined or failed.', 'error');
                        resetSubBtn();
                    }

                    if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        closeDashModal('processingModal');
                        showAlert('Payment check timed out. Please check SMS for confirmation.', 'error');
                        resetSubBtn();
                    }

                } catch (e) { console.error(e); }
            }, 3000);
        }

        function checkSubscriptionStatus(subData) {
            if (!subData || !subData.expiry) return;

            const expiryDate = new Date(subData.expiry);
            const now = new Date();

            if (expiryDate < now) {
                // Show Banner
                const banner = document.getElementById('expiryBanner');
                banner.style.display = 'block';

                // Optional: Update text to be more specific
                // banner.innerHTML = `< strong >⚠️ EXPIRED:</strong > Your plan expired on ${ expiryDate.toLocaleDateString() }.<span style="text-decoration:underline; margin-left:10px;">Renew Now</span>`;
            } else {
                document.getElementById('expiryBanner').style.display = 'none';
            }
        }
    </script>

    <!-- Custom Alert Modal (Higher Z-Index) -->
    <div id="customAlertModal" class="dashboard-modal hidden" style="z-index: 11000;">
        <div class="dashboard-modal-content" style="max-width: 400px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <i class="fas fa-info-circle" style="font-size: 3rem; color: #4caf50;" id="alertIcon"></i>
            </div>
            <h3 id="customAlertTitle">Alert</h3>
            <p id="customAlertMessage" style="color: #555; margin-bottom: 20px;">Message goes here</p>
            <button onclick="document.getElementById('customAlertModal').classList.add('hidden')" class="btn-submit"
                style="width: 100%;">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal (Higher Z-Index) -->
    <div id="customConfirmModal" class="dashboard-modal hidden" style="z-index: 11000;">
        <div class="dashboard-modal-content" style="max-width: 400px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <i class="fas fa-question-circle" style="font-size: 3rem; color: #FF9800;"></i>
            </div>
            <h3>Confirmation</h3>
            <p id="customConfirmMessage" style="color: #555; margin-bottom: 20px;">Are you sure?</p>
            <div class="modal-actions" style="justify-content: center; gap: 10px;">
                <button id="confirmCancelBtn" class="btn-cancel">Cancel</button>
                <button id="confirmOkBtn" class="btn-submit">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Processing Modal (New) -->
    <div id="processingModal" class="dashboard-modal hidden" style="z-index: 11000;">
        <div class="dashboard-modal-content" style="text-align: center; background: #333; color: white;">
            <div class="spinner"
                style="margin: 20px auto; border: 4px solid #555; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;">
            </div>
            <h3 style="color: white;">Processing Payment...</h3>
            <p style="color: #ddd;">Please check your phone to approve the transaction.</p>
            <div id="progressBar"
                style="width: 100%; height: 6px; background: #555; border-radius: 3px; margin-top: 15px; overflow: hidden;">
                <div style="width: 0%; height: 100%; background: #3498db; transition: width 0.5s;"></div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- Success Modal -->
    <div id="successModal" class="dashboard-modal hidden" style="z-index: 11001;">
        <div class="dashboard-modal-content" style="text-align: center;">
            <div style="margin-bottom: 10px;">
                <i class="fas fa-check-circle" style="font-size: 4rem; color: #4caf50;"></i>
            </div>
            <h3 style="color: #4caf50; margin-bottom: 10px;">Transaction Successful!</h3>
            <p id="successMessage" style="font-size: 1.1em; color: #333; margin-bottom: 20px;"></p>
            <button onclick="closeDashModal('successModal')" class="btn-submit" style="width: 100%;">Awesome!</button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="dashboard-modal hidden">
        <!-- ... existing content ... -->
    </div>

    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="dashboard-modal hidden" style="z-index: 10002;">
        <div class="dashboard-modal-content">
            <h3 style="color: #4caf50;">Renew Subscription</h3>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                Keep your account active to continue managing vouchers & payments.
            </p>

            <label>Confirm Phone Number</label>
            <input type="text" id="subPhone" placeholder="+256..."
                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">

            <label>Duration</label>
            <select id="subDuration" onchange="updateSubAmount()"
                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="1">1 Month</option>
                <option value="3">3 Months</option>
                <option value="6">6 Months</option>
                <option value="12">1 Year (Best Value)</option>
            </select>

            <div
                style="background: rgba(0, 0, 0, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center;">
                <span style="display: block; font-size: 0.8em; color: #888; margin-bottom: 5px;">TOTAL TO PAY</span>
                <strong id="subAmountDisplay" style="font-size: 1.5em; color: #fff;">20,000 UGX</strong>
            </div>

            <div class="modal-actions">
                <button onclick="initiateSubscription()" class="btn-success" id="btnPaySub">Pay Now</button>
                <button onclick="closeDashModal('subscriptionModal')" class="btn-cancel">Cancel</button>
            </div>
            <p id="subStatusMsg" style="margin-top: 10px; font-size: 0.85em; color: #666; text-align: center;"></p>
        </div>
    </div>
    </div>
</body>
</body>

</html>